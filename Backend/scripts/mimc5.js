// mimc5.js

const FIELD_MODULUS = BigInt("21888242871839275222246405745257275088548364400416034343698204186575808495617");

const c = [
    0n,
    25823191961023811529686723375255045606187170120624741056268890390838310270028n,
    71153255768872006974285801937521995907343848376936063113800887806988124358800n,
    51253176922899201987938365653129780755804051536550826601168630951148399005246n,
    66651710483985382365580181188706173532487386392003341306307921015066514594406n,
    45887003413921204775397977044284378920236104620216194900669591190628189327887n,
    14399999722617037892747232478295923748665564430258345135947757381904956977453n,
    29376176727758177809204424209125257629638239807319618360680345079470240949145n,
    13768859312518298840937540532277016512087005174650120937309279832230513110846n,
    54749662990362840569021981534456448557155682756506853240029023635346061661615n,
    25161436470718351277017231215227846535148280460947816286575563945185127975034n,
    90370030464179443930112165274275271350651484239155016554738639197417116558730n,
    92014788260850167582827910417652439562305280453223492851660096740204889381255n,
    40376490640073034398204558905403523738912091909516510156577526370637723469243n,
    903792244391531377123276432892896247924738784402045372115602887103675299839n,
    112203415202699791888928570309186854585561656615192232544262649073999791317171n,
    114801681136748880679062548782792743842998635558909635247841799223004802934045n,
    111440818948676816539978930514468038603327388809824089593328295503672011604028n,
    64965960071752809090438003157362764845283225351402746675238539375404528707397n,
    98428510787134995495896453413714864789970336245473413374424598985988309743097n
];

function mod(a) {
    return ((a % FIELD_MODULUS) + FIELD_MODULUS) % FIELD_MODULUS;
}

function mimc5Feistel(iL, iR, k) {
    let left = BigInt(iL);
    let right = BigInt(iR);
    const key = BigInt(k);

    for (let i = 0; i < c.length; i++) {
        let t = mod(right + key + c[i]);
        let t2 = mod(t * t);
        let t4 = mod(t2 * t2);
        let newRight = mod(left + mod(t4 * t));
        left = right;
        right = newRight;
    }

    return [left, right];
}

function mimc5Sponge(inputs, k) {
    let R = 0n;
    let C = 0n;
    const key = BigInt(k);

    for (const x of inputs) {
        const input = BigInt(x);
        R = mod(R + input);
        [R, C] = mimc5Feistel(R, C, key);
    }

    return R;
}

module.exports = { mimc5Sponge };
